select version();
SELECT * FROM pg_available_extensions;

delete from webpage if exists

CREATE EXTENSION vector;
create table webpage(
    page_id int primary key,
    name text,
    url text,
    category text,
    gender text
);

create table garment (
    garment_id int primary key,
    page_id int,
    seg_id int,
    photo text
);
CREATE INDEX garment_pageid_index ON garment(page_id);
CREATE INDEX garment_segid_index ON garment(seg_id);

create table garment_vector(
    garment_id int primary key,
    vecdata vector(192)
);
-- A good place to start is 4 * sqrt(rows) the number of inverted lists
CREATE INDEX  l2_vector_index ON  garment_vector 
USING ivfflat (vecdata vector_l2_ops) WITH (lists = 1000);
-- CREATE INDEX ON table USING ivfflat (column opclass) WHERE (other_column = 123);

select garment_id,seg_id,photo from garment where garment_id>0 order by garment_id limit 10 
select * from garment where page_id=136450 limit 10
select * from garment_vector

CREATE TABLE testtable(vecdata vector(3));
INSERT INTO testtable VALUES ('[1,2,3]'), ('[4,5,6]');

--dot index
CREATE INDEX ip_index ON testtable 
USING ivfflat (vecdata vector_ip_ops) WITH (lists = 100);

--cosine index
CREATE INDEX cosine_index ON testtable 
USING ivfflat (vecdata vector_cosine_ops) WITH (lists = 100);

explain analyze
SELECT *,vecdata <-> '[1,1,1]'
,inner_product(vecdata, '[1,2,2]')
,cosine_distance(vecdata, '[1,2,3]')
FROM testtable 
ORDER BY vecdata <=> '[3,1,2]' LIMIT 1;

select count(*) from garment_vector
--select similar to vector
explain analyze
with req as(
    select g.garment_id,g.seg_id,g.photo,v.vecdata from garment g
    inner join garment_vector v on g.garment_id=v.garment_id
    where g.garment_id=1 limit 1
)
select g.garment_id,g.seg_id,g.photo, (select req.vecdata from req) <-> v.vecdata as distance
from garment_vector v
inner join garment g on g.garment_id=v.garment_id
order by v.vecdata <-> (select req.vecdata from req)  limit 10


explain analyze
with req as(
    select g.garment_id,g.seg_id,g.photo,v.vecdata from garment g
    inner join garment_vector v on g.garment_id=v.garment_id
    where g.garment_id=2 limit 1
)
select g.garment_id,g.seg_id,g.photo, (select req.vecdata from req) <-> v.vecdata as distance
from garment_vector v
inner join garment g on g.garment_id=v.garment_id
where (select req.vecdata from req) <-> v.vecdata<0.3
order by v.vecdata <-> (select req.vecdata from req)  limit 10


explain analyze
select *
from garment_vector v1
inner join garment g on g.garment_id=v1.garment_id
order by v1.vecdata <-> '[-0.047943115234375,0.02069091796875,-0.04364013671875,0.09161376953125,-0.0238189697265625,0.03277587890625,0.06683349609375,-0.076904296875,0.07275390625,-0.10015869140625,0.003177642822265625,0.050811767578125,0.11614990234375,-0.043792724609375,-0.008514404296875,-0.14111328125,0.0506591796875,-0.059661865234375,-0.0277099609375,-0.0186614990234375,-0.07220458984375,0.04241943359375,0.0528564453125,0.07513427734375,-0.023284912109375,-0.046905517578125,0.0882568359375,-0.1104736328125,0.06378173828125,0.0897216796875,0.047882080078125,0.0076751708984375,-0.0215911865234375,-0.038970947265625,0.16748046875,-0.09698486328125,-0.08673095703125,-0.1417236328125,-0.0010776519775390625,0.11871337890625,0.10833740234375,-0.06512451171875,0.0692138671875,-0.04144287109375,0.0762939453125,0.017913818359375,0.04693603515625,-0.07623291015625,-0.1854248046875,-0.01004791259765625,-0.099365234375,0.01184844970703125,-0.0654296875,-0.031951904296875,-0.0885009765625,0.007293701171875,0.0771484375,-0.053314208984375,0.048492431640625,-0.07159423828125,-0.0027561187744140625,0.0209808349609375,-0.040985107421875,-0.03466796875,-0.054412841796875,0.0204620361328125,0.025238037109375,0.06640625,0.1239013671875,-0.0433349609375,0.035675048828125,-0.01482391357421875,0.2169189453125,0.1021728515625,-0.061981201171875,-0.032379150390625,-0.1142578125,0.07073974609375,0.0028171539306640625,-0.0248260498046875,0.044708251953125,-0.025054931640625,-0.061309814453125,0.06298828125,0.08807373046875,-0.001552581787109375,-0.0772705078125,0.044036865234375,-0.1077880859375,0.05450439453125,0.019317626953125,-0.050689697265625,0.01311492919921875,-0.009124755859375,0.0333251953125,0.02313232421875,0.003917694091796875,-0.051910400390625,-0.07000732421875,-0.01239776611328125,-0.1512451171875,0.10101318359375,0.0086517333984375,-0.1263427734375,0.057830810546875,0.16064453125,0.06500244140625,0.06988525390625,0.0855712890625,0.037261962890625,-0.09710693359375,-0.020050048828125,0.033477783203125,-0.057159423828125,-0.07147216796875,-0.091796875,0.05810546875,0.01204681396484375,0.01006317138671875,0.030853271484375,0.161376953125,-0.044189453125,0.034271240234375,0.0794677734375,0.0450439453125,0.0694580078125,0.0335693359375,0.0060882568359375,-0.0144805908203125,0.008056640625,-0.07879638671875,0.09033203125,0.06524658203125,-0.018096923828125,-0.060577392578125,-0.08233642578125,0.1383056640625,0.079833984375,0.137939453125,-0.009674072265625,-0.04815673828125,0.1602783203125,-0.0634765625,-0.056610107421875,-0.009246826171875,0.1226806640625,0.025054931640625,0.062744140625,-0.0195465087890625,-0.01097869873046875,0.034515380859375,0.08258056640625,-0.0718994140625,-0.0160369873046875,-0.05908203125,-0.037994384765625,0.1029052734375,-0.08709716796875,-0.1265869140625,0.08673095703125,-0.064208984375,0.0204925537109375,0.0997314453125,0.005489349365234375,0.0489501953125,0.0079193115234375,0.0156402587890625,-0.0303192138671875,0.023101806640625,-0.0938720703125,0.01537322998046875,0.040924072265625,0.0085906982421875,0.1334228515625,-0.07183837890625,-0.01428985595703125,-0.007022857666015625,-0.1143798828125,0.0157318115234375,0.0997314453125,0.09320068359375,-0.2059326171875,-0.040435791015625,0.03125,-0.085693359375,-0.030853271484375,0.003208160400390625,-0.01678466796875,-0.00936126708984375,-0.03985595703125,0.037017822265625,0.04705810546875]'  limit 10

explain analyze
select *
from garment_vector v1
order by v1.vecdata <-> '[-0.047943115234375,0.02069091796875,-0.04364013671875,0.09161376953125,-0.0238189697265625,0.03277587890625,0.06683349609375,-0.076904296875,0.07275390625,-0.10015869140625,0.003177642822265625,0.050811767578125,0.11614990234375,-0.043792724609375,-0.008514404296875,-0.14111328125,0.0506591796875,-0.059661865234375,-0.0277099609375,-0.0186614990234375,-0.07220458984375,0.04241943359375,0.0528564453125,0.07513427734375,-0.023284912109375,-0.046905517578125,0.0882568359375,-0.1104736328125,0.06378173828125,0.0897216796875,0.047882080078125,0.0076751708984375,-0.0215911865234375,-0.038970947265625,0.16748046875,-0.09698486328125,-0.08673095703125,-0.1417236328125,-0.0010776519775390625,0.11871337890625,0.10833740234375,-0.06512451171875,0.0692138671875,-0.04144287109375,0.0762939453125,0.017913818359375,0.04693603515625,-0.07623291015625,-0.1854248046875,-0.01004791259765625,-0.099365234375,0.01184844970703125,-0.0654296875,-0.031951904296875,-0.0885009765625,0.007293701171875,0.0771484375,-0.053314208984375,0.048492431640625,-0.07159423828125,-0.0027561187744140625,0.0209808349609375,-0.040985107421875,-0.03466796875,-0.054412841796875,0.0204620361328125,0.025238037109375,0.06640625,0.1239013671875,-0.0433349609375,0.035675048828125,-0.01482391357421875,0.2169189453125,0.1021728515625,-0.061981201171875,-0.032379150390625,-0.1142578125,0.07073974609375,0.0028171539306640625,-0.0248260498046875,0.044708251953125,-0.025054931640625,-0.061309814453125,0.06298828125,0.08807373046875,-0.001552581787109375,-0.0772705078125,0.044036865234375,-0.1077880859375,0.05450439453125,0.019317626953125,-0.050689697265625,0.01311492919921875,-0.009124755859375,0.0333251953125,0.02313232421875,0.003917694091796875,-0.051910400390625,-0.07000732421875,-0.01239776611328125,-0.1512451171875,0.10101318359375,0.0086517333984375,-0.1263427734375,0.057830810546875,0.16064453125,0.06500244140625,0.06988525390625,0.0855712890625,0.037261962890625,-0.09710693359375,-0.020050048828125,0.033477783203125,-0.057159423828125,-0.07147216796875,-0.091796875,0.05810546875,0.01204681396484375,0.01006317138671875,0.030853271484375,0.161376953125,-0.044189453125,0.034271240234375,0.0794677734375,0.0450439453125,0.0694580078125,0.0335693359375,0.0060882568359375,-0.0144805908203125,0.008056640625,-0.07879638671875,0.09033203125,0.06524658203125,-0.018096923828125,-0.060577392578125,-0.08233642578125,0.1383056640625,0.079833984375,0.137939453125,-0.009674072265625,-0.04815673828125,0.1602783203125,-0.0634765625,-0.056610107421875,-0.009246826171875,0.1226806640625,0.025054931640625,0.062744140625,-0.0195465087890625,-0.01097869873046875,0.034515380859375,0.08258056640625,-0.0718994140625,-0.0160369873046875,-0.05908203125,-0.037994384765625,0.1029052734375,-0.08709716796875,-0.1265869140625,0.08673095703125,-0.064208984375,0.0204925537109375,0.0997314453125,0.005489349365234375,0.0489501953125,0.0079193115234375,0.0156402587890625,-0.0303192138671875,0.023101806640625,-0.0938720703125,0.01537322998046875,0.040924072265625,0.0085906982421875,0.1334228515625,-0.07183837890625,-0.01428985595703125,-0.007022857666015625,-0.1143798828125,0.0157318115234375,0.0997314453125,0.09320068359375,-0.2059326171875,-0.040435791015625,0.03125,-0.085693359375,-0.030853271484375,0.003208160400390625,-0.01678466796875,-0.00936126708984375,-0.03985595703125,0.037017822265625,0.04705810546875]'  limit 10

explain analyze
select *
from garment_vector v1
order by v1.vecdata <-> (select v2.vecdata from garment_vector v2 where v2.garment_id=1)  limit 10

explain analyze
select *
from garment_vector v1,
garment_vector v2 
where v2.garment_id=1
order by v1.vecdata <-> v2.vecdata  limit 10

select version()

SELECT
    relname AS "relation",
    pg_size_pretty (
        pg_total_relation_size (C .oid)
    ) AS "total_size"
FROM
    pg_class C
LEFT JOIN pg_namespace N ON (N.oid = C .relnamespace)
WHERE
    nspname NOT IN (
        'pg_catalog',
        'information_schema'
    )
AND C .relkind <> 'i'
AND nspname !~ '^pg_toast'
ORDER BY
    pg_total_relation_size (C .oid) DESC

